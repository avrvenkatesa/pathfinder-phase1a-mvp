extends:
  - "spectral:oas"

rules:
  # ---- Project-specific runtime gates ----
  runtime-requires-401:
    description: "Runtime endpoints must document 401 (auth gate)."
    message: "Add a 401 response for this runtime operation."
    severity: error
    given: "$.paths[?(@property.match(/^(\\/api\\/(instances|workflows)\\b.*)/))][*].responses"
    then:
      - function: schema
        functionOptions:
          schema:
            type: object
            required: ["401"]

  runtime-requires-429:
    description: "Runtime endpoints must document 429 (rate limiting)."
    message: "Add a 429 response for this runtime operation."
    severity: error
    given: "$.paths[?(@property.match(/^(\\/api\\/(instances|workflows)\\b.*)/))][*].responses"
    then:
      - function: schema
        functionOptions:
          schema:
            type: object
            required: ["429"]

  runtime-requires-security:
    description: "Runtime endpoints must declare operation-level security."
    message: "Add an operation-level 'security' array for gated runtime routes."
    severity: error
    given: "$.paths[?(@property.match(/^(\\/api\\/(instances|workflows)\\b.*)/))][*]"
    then:
      - field: security
        function: truthy

  # ---- Quality hygiene rules (kept strict) ----
  operation-operationId:
    description: "Each operation must have a unique operationId."
    message: "Missing operationId."
    severity: error
    given: "$.paths[*][*]"
    then:
      - field: operationId
        function: truthy

  operation-summary:
    description: "Each operation should have a concise summary."
    message: "Missing or empty summary."
    severity: warn
    given: "$.paths[*][*]"
    then:
      - field: summary
        function: truthy

  operation-tags:
    description: "Each operation should have at least one tag."
    message: "Add at least one tag."
    severity: warn
    given: "$.paths[*][*]"
    then:
      - field: tags
        function: schema
        functionOptions:
          schema:
            type: array
            minItems: 1
            items:
              type: string

  # Optional: encourage examples for 4xx responses on runtime ops
  runtime-4xx-have-examples:
    description: "Runtime 4xx responses should include an example for error shape conformance."
    message: "Add an example under responses[status].content[app/json].examples or example."
    severity: hint
    given: >
      $.paths[?(@property.match(/^(\/api\/(instances|workflows)\b.*)/))][*].responses[?(@property.match(/^(4\d\d)$/))].content["application/json"]
    then:
      - function: xor
        functionOptions:
          properties:
            - example
            - examples
